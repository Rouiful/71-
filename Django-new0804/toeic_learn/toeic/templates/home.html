{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEICå­¸ç¿’å¹³å°</title>
    <link rel="stylesheet" href="{% static 'css/common.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body {% if not user.is_authenticated %}class="no-auth"{% endif %}>
    <div class="header">
        <button class="menu-btn" id="menu-btn">â˜°</button>
        <h1>TOEICå­¸ç¿’å¹³å°</h1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <div class="nav-buttons">
            <a href="{% url 'home' %}" target="_self">
                <button class="nav-btn {% if request.path == '/' %}current{% endif %}">
                    <i class="fas fa-home"></i> é¦–é 
                </button>
            </a>
            <a href="{% url 'test' %}" target="_self">
                <button class="nav-btn {% if request.path == '/test/' %}current{% endif %}">
                    <i class="fas fa-file-alt"></i> æ¸¬é©—å¹³å°
                </button>
            </a>
            {% if user.is_authenticated %}
                <a href="{% url 'record' %}" target="_self">
                    <button class="nav-btn">
                        <i class="fas fa-user"></i> æ­¡è¿, {{ user.nickname }}
                    </button>
                </a>
                <form id="logout-form" action="{% url 'logout' %}" method="POST" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="nav-btn">
                        <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                    </button>
                </form>
            {% else %}
                <a href="{% url 'login' %}" target="_self">
                    <button class="nav-btn {% if request.path == '/login/' %}current{% endif %}">
                        <i class="fas fa-user"></i> æœƒå“¡è¨»å†Š/ç™»å…¥
                    </button>
                </a>
            {% endif %}
        </div>
    </div>
    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}

    <div class="main-content">
        <div class="content">
            <div class="marquee-container">
                <div class="marquee-text">
                    <h1>æ¢ç´¢è‹±èªå­¸ç¿’çš„ç„¡é™å¯èƒ½ï¼Œè®“æ‚¨çš„é€²æ­¥å¾é€™è£¡é–‹å§‹ï¼Œæ‰“é€ å°ˆå±¬æ–¼æ‚¨çš„é«˜æ•ˆå¤šç›Šå­¸ç¿’ä¹‹æ—…ï¼</h1>
                </div>
            </div>
        </div>
        <div class="scroll-down">â¬‡ æ»‘å‹•ä»¥æŸ¥çœ‹æ›´å¤šå…§å®¹</div>

        <div class="carousel">
            <div class="carousel-images" id="carousel-images">
                <img src="https://blog.tripbaa.com/wp-content/uploads/2020/10/plan_2020090316351725750_b.jpg"
                alt="Image 1" class="carousel-image">
                <img src="https://www.necoast-nsa.gov.tw/FileArtPic.ashx?id=791&w=600&h=400"
                alt="Image 2" class="carousel-image">
                <img src="https://pgw.udn.com/gw/photo.php?u=https://uc.udn.com.tw/photo/2024/09/25/realtime/30605412.jpg&s=Y&x=0&y=0&sw=7629&sh=5089&exp=3600"
                alt="Image 3" class="carousel-image">
            </div>
            <button class="carousel-button carousel-button-left" id="prevBtn">â®</button>
            <button class="carousel-button carousel-button-right" id="nextBtn">â¯</button>
        </div>
    </div>

    <div id="ai-chatbot-container" style="display: none;">
        <div id="chatbot-header">
            å¤šç›Šå–®å­—å°å¹«æ‰‹
            <button id="chatbot-close-btn">&times;</button>
        </div>
        <div id="chatbot-messages">
            </div>
        <div id="chatbot-input-area">
            <input type="text" id="user-input" placeholder="è¼¸å…¥ã€Œé–‹å§‹ã€ä¾†é ˜å–å–®å­—...">
            <button id="send-btn">ç™¼é€</button>
        </div>
    </div>
    <button id="chatbot-toggle-btn">å¤šç›Šå–®å­—å°å¹«æ‰‹</button>


    <footer class="footer">
        <div class="footer-container">
            <div class="contact-us">
                <h3>è¯çµ¡æˆ‘å€‘</h3>
                <ul>
                    <li><i class="fas fa-phone"></i><a href="tel:02 3322 2777"> é›»è©±ï¼š02 3322 2777</a></li>
                    <li><i class="fas fa-map"></i><a href="https://maps.google.com/maps?q=100å°åŒ—å¸‚ä¸­æ­£å€æ¿Ÿå—è·¯ä¸€æ®µ321è™Ÿ" target="_blank"> åœ°å€ï¼š100å°åŒ—å¸‚ä¸­æ­£å€æ¿Ÿå—è·¯ä¸€æ®µ321è™Ÿ</a></li>
                    <iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3614.779774567228!2d121.52495111500305!3d25.04253398396551!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3442a96937e008c7%3A0x6b8c9d4b0d0a25b!2zMTAw5Y-w5b-Y5L-h5b-Y5L-h5YyX5bmz6LSi6LSi6JukMTUx6JukNTk26Juk!5e0!3m2!1szh-TW!2stw!4v1652199732731!5m2!1szh-TW!2stw"
                        height="250"
                        style="border:0;"
                        allowfullscreen=""
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>Â© 2025 TOEICå­¸ç¿’å¹³å° ç‰ˆæ¬Šæ‰€æœ‰</p>
        </div>
    </footer>

    <script>
    // âœ… æ ¹æ“šå¾Œç«¯å‚³ä¾†çš„ä½¿ç”¨è€…åç¨±ï¼Œå»ºç«‹ä¸€å€‹å”¯ä¸€çš„ localStorage key
    const currentUsername = "{{ username }}";
    const storageKey = `chatbot_history_${currentUsername}`;
    // æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥
    const isAuthenticated = "{{ user.is_authenticated }}" === "True";


    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const chatbotContainer = document.getElementById('ai-chatbot-container');
        const chatbotToggleBtn = document.getElementById('chatbot-toggle-btn');
        const chatbotCloseBtn = document.getElementById('chatbot-close-btn');
        const chatbotMessages = document.getElementById('chatbot-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const csrfToken = getCookie('csrftoken');
        const logoutForm = document.getElementById('logout-form');

        // å¦‚æœä½¿ç”¨è€…æœªç™»å…¥ï¼Œå‰‡ç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œ AI æ©Ÿå™¨äººç›¸é—œçš„é‚è¼¯
        if (!isAuthenticated) {
            return;
        }

        // âœ… è² è²¬ç‚ºæ‰€æœ‰å–®å­—å¡ç‰‡æŒ‰éˆ•ç¶å®šäº‹ä»¶ï¼ˆä¿®æ­£äº†é‡è¤‡ç¶å®šçš„å•é¡Œï¼‰
        function bindFamiliarButtonEvents() {
            const buttons = chatbotMessages.querySelectorAll('.mark-familiar-btn');
            buttons.forEach(button => {
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼Œé¿å…é‡è¤‡åŸ·è¡Œ
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);

                newButton.addEventListener('click', function(e) {
                    const wordId = e.target.dataset.wordId;
                    markWordAsFamiliar(wordId);
                });
            });
        }

        // å¾ localStorage è¼‰å…¥å°è©±ç´€éŒ„
        function loadChatHistory() {
            const history = localStorage.getItem(storageKey);
            if (history) {
                chatbotMessages.innerHTML = history;
                // é é¢åŠ è¼‰æ™‚ä¸è‡ªå‹•æ»¾å‹•ï¼Œåªåœ¨æ‰“é–‹èŠå¤©è¦–çª—æ™‚æ»¾å‹•
                bindFamiliarButtonEvents();
            } else {
                addMessage('robot', 'å“ˆå›‰ï¼æˆ‘æ˜¯ä½ çš„ AI å­¸ç¿’å°å¹«æ‰‹ã€‚è¼¸å…¥ã€Œé–‹å§‹ã€ä¾†é ˜å–ä½ ä»Šå¤©çš„å–®å­—å§ï¼');
            }
        }

        // å°‡å°è©±ç´€éŒ„ä¿å­˜åˆ° localStorage
        function saveChatHistory() {
            localStorage.setItem(storageKey, chatbotMessages.innerHTML);
        }

        function addMessage(sender, htmlContent, isVocabCard = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chatbot-message', `${sender}-message`);
            messageDiv.innerHTML = htmlContent;
            chatbotMessages.appendChild(messageDiv);
            // âœ… æ¯æ¬¡æ–°å¢è¨Šæ¯å¾Œéƒ½è‡ªå‹•æ»¾å‹•åˆ°æœ€åº•éƒ¨
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            saveChatHistory();
            if (isVocabCard) {
                bindFamiliarButtonEvents();
            }
        }

        // âœ… ä¿®æ­£äº†é–‹å•Ÿ/é—œé–‰èŠå¤©è¦–çª—çš„é‚è¼¯
        chatbotToggleBtn.addEventListener('click', () => {
            chatbotContainer.style.display = 'flex';
            chatbotToggleBtn.style.display = 'none'; // é–‹å•Ÿæ™‚éš±è—æŒ‰éˆ•
            // âœ… æ–°å¢ï¼šé–‹å•ŸèŠå¤©è¦–çª—æ™‚è‡ªå‹•æ»¾å‹•è‡³æœ€åº•éƒ¨
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
        });

        chatbotCloseBtn.addEventListener('click', () => {
            chatbotContainer.style.display = 'none';
            chatbotToggleBtn.style.display = 'block'; // é—œé–‰æ™‚é¡¯ç¤ºæŒ‰éˆ•
        });

        // ğŸš¨ ä¿®æ­£ï¼šç§»é™¤ç™»å‡ºæ™‚æ¸…é™¤ localStorage çš„ç¨‹å¼ç¢¼ï¼Œä»¥ä¿ç•™èŠå¤©ç´€éŒ„
        if (logoutForm) {
            logoutForm.addEventListener('submit', function() {
                // ç§»é™¤æ­¤è¡Œç¨‹å¼ç¢¼ï¼Œä»¥ä¿ç•™èŠå¤©ç´€éŒ„
            });
        }

        function sendMessage() {
            const message = userInput.value.trim();
            if (message === '') return;

            addMessage('user', message);
            userInput.value = '';

            if (message.toLowerCase() === 'é–‹å§‹') {
                fetchDailyVocabulary();
            } else {
                addMessage('robot', 'æŠ±æ­‰ï¼Œæˆ‘ç›®å‰åªèƒ½è­˜åˆ¥ã€Œé–‹å§‹ã€æŒ‡ä»¤ä¾†æä¾›å–®å­—å–”ï¼');
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        function fetchDailyVocabulary() {
            fetch('/api/chatbot/vocabulary/', {
                method: 'GET',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.words && data.words.length > 0) {
                    addMessage('robot', data.message);
                    data.words.forEach(word => {
                        const card = `
                            <div class="vocab-card">
                                <h4>
                                    <span class="word-text">${word.word}</span>
                                    <span class="word-translation">${word.translation}</span>
                                    <span class="pronunciation-text">${word.pronunciation}</span>
                                    <span class="part-of-speech">${word.part_of_speech}</span>
                                </h4>
                                <p class="example-sentence">ä¾‹å¥ï¼š${word.example_sentence}</p>
                                <p class="example-translation">ç¿»è­¯ï¼š${word.example_translation}</p>
                                <button class="mark-familiar-btn" data-word-id="${word.word_id}">æˆ‘å·²ç†Ÿæ‚‰é€™å€‹å–®å­—</button>
                            </div>
                        `;
                        addMessage('robot', card, true);
                    });
                } else {
                    addMessage('robot', data.message);
                }
            })
            .catch(error => {
                console.error('Error fetching vocabulary:', error);
                addMessage('robot', 'ç³Ÿç³•ï¼ç„¡æ³•å–å¾—å–®å­—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            });
        }

        // âœ… ä¿®æ­£äº† markWordAsFamiliar å‡½å¼ï¼Œé¿å…é‡è¤‡ç™¼é€è«‹æ±‚
        function markWordAsFamiliar(wordId) {
            const button = chatbotMessages.querySelector(`button[data-word-id="${wordId}"]`);
            if (button) {
                button.disabled = true;
                button.textContent = 'å·²æ¨™è¨˜';
            }

            fetch('/api/chatbot/mark-familiar/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ word_id: wordId })
            })
            .then(response => response.json())
            .then(data => {
                addMessage('robot', data.message);
            })
            .catch(error => {
                console.error('Error marking word as familiar:', error);
                addMessage('robot', 'æ¨™è¨˜å–®å­—æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            });
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        loadChatHistory();

        // âœ… ç§»é™¤æ­¤è™•çš„æ»¾å‹•ç¨‹å¼ç¢¼ï¼Œå› ç‚ºå®ƒæœƒå°è‡´é é¢åŠ è¼‰æ™‚å°±æ»¾å‹•ã€‚
        // æˆ‘å€‘å°‡æ»¾å‹•åŠŸèƒ½ç§»åˆ°é–‹å•ŸèŠå¤©è¦–çª—æ™‚åŸ·è¡Œã€‚
    });
</script>
</body>
</html>
